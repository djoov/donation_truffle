{% extends 'base.html' %}

{% block content %}
<div class="container d-flex align-items-center justify-content-center min-vh-100 py-5">
    <div class="card auth-card shadow-2xl border-0 rounded-4 w-100 overflow-hidden" style="max-width: 900px; background: white;">
        <div class="row g-0">
            
            <!-- KOLOM KIRI: MASKOT 3D (SIDEBAR) -->
            <div class="col-lg-5 d-none d-lg-flex align-items-center justify-content-center position-relative" 
                 style="background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); min-height: 600px;">
                
                <!-- Dekorasi Background -->
                <div class="position-absolute top-0 start-0 w-100 h-100" style="opacity: 0.1; background-image: radial-gradient(#ffffff 1px, transparent 1px); background-size: 20px 20px; pointer-events: none;"></div>
                
                <div class="text-center position-relative z-10 w-100 h-100 d-flex flex-column justify-content-center">
                    <!-- Container Maskot -->
                    <div class="mascot-container w-100" style="height: 400px; position: relative; z-index: 20;">
                        <!-- Canvas Transparan -->
                        <canvas id="register-mascot-canvas" style="width: 100%; height: 100%; display: block; background-color: transparent !important; outline: none;"></canvas>
                    </div>
                    
                    <div class="px-4 mt-n4 position-relative z-20">
                        <h5 class="text-white fw-bold mb-1" style="font-family: 'Outfit', sans-serif;">One Time Setup</h5>
                        <p class="text-white-50 small">Pilih akun Ganache Anda untuk memulai.</p>
                    </div>
                </div>
            </div>

            <!-- KOLOM KANAN: FORM REGISTER -->
            <div class="col-lg-7">
                <div class="card-body p-4 p-md-5">
                    <div class="mb-4">
                        <h3 class="fw-bold" style="font-family: 'Outfit', sans-serif; color: var(--primary-color);">Setup Akun Web3</h3>
                        <p class="text-muted small">Hubungkan akun Ganache lokal Anda.</p>
                    </div>

                    <form action="{{ url_for('register') }}" method="POST">
                        
                        <!-- 1. DATA PENGGUNA -->
                        <h6 class="text-uppercase text-muted small fw-bold mb-3 border-bottom pb-2">Data Profil</h6>
                        <div class="row g-2">
                            <div class="col-md-6">
                                <div class="form-floating mb-2">
                                    <input type="text" class="form-control bg-light border-0" id="username" name="username" placeholder="Username" required>
                                    <label for="username">Username</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-floating mb-2">
                                    <select class="form-select bg-light border-0" id="role" name="role" required>
                                        <option value="donatur" selected>ðŸ’™ Donatur</option>
                                        <option value="kreator">ðŸ“¢ Kreator Kampanye</option>
                                    </select>
                                    <label for="role">Peran</label>
                                </div>
                            </div>
                        </div>

                        <div class="form-floating mb-2">
                            <input type="email" class="form-control bg-light border-0" id="email" name="email" placeholder="Email" required>
                            <label for="email">Alamat Email</label>
                        </div>
                        <div class="form-floating mb-3">
                            <input type="password" class="form-control bg-light border-0" id="password" name="password" placeholder="Password" required>
                            <label for="password">Password Login</label>
                        </div>

                        <!-- 2. DATA BLOCKCHAIN (DROPDOWN GANACHE) -->
                        <h6 class="text-uppercase text-muted small fw-bold mb-3 border-bottom pb-2 mt-4">
                            <i class="fas fa-link me-1"></i> Koneksi Ganache
                        </h6>
                        
                        <div class="alert alert-warning py-2 px-3 small d-flex align-items-center gap-2 mb-3">
                            <i class="fas fa-info-circle"></i>
                            <div>
                                <strong>Penting:</strong> Pilih akun yang tersedia di Ganache. 
                                <br>Private Key tetap harus diisi manual (Klik ikon ðŸ”‘ di Ganache).
                            </div>
                        </div>

                        <div class="form-floating mb-2">
                            <select class="form-select bg-light border-0 font-monospace" id="wallet_address" name="wallet_address" required>
                                <option value="" disabled selected>-- Pilih Akun Ganache --</option>
                                {% for acc in accounts %}
                                    <option value="{{ acc }}">{{ acc }}</option>
                                {% else %}
                                    <option value="" disabled>Tidak ada akun terdeteksi (Cek Koneksi)</option>
                                {% endfor %}
                            </select>
                            <label for="wallet_address">Pilih Wallet Address</label>
                        </div>

                        <div class="form-floating mb-4">
                            <input type="password" class="form-control bg-light border-0 font-monospace" id="private_key" name="private_key" placeholder="Private Key" required>
                            <label for="private_key">Paste Private Key (Dari Ganache)</label>
                        </div>

                        <div class="form-check mb-4">
                            <input class="form-check-input" type="checkbox" value="" id="flexCheckDefault" required>
                            <label class="form-check-label small text-muted" for="flexCheckDefault">
                                Saya mengizinkan aplikasi menyimpan kunci saya untuk tanda tangan otomatis.
                            </label>
                        </div>

                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary btn-lg rounded-pill shadow-sm">
                                <i class="fas fa-plug me-2"></i> Daftar & Hubungkan
                            </button>
                        </div>
                    </form>

                    <div class="text-center mt-3">
                        <small class="text-muted">Sudah punya akun? <a href="{{ url_for('login') }}" class="fw-bold text-decoration-none">Masuk</a></small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- SCRIPTS 3D (Identik dengan Login.html agar bentuk maskot sama) -->
<script async src="https://unpkg.com/es-module-shims@1.6.3/dist/es-module-shims.js"></script>
<script type="importmap">
  { "imports": { "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js" } }
</script>

<script type="module">
    import * as THREE from 'three';

    function initMascot() {
        const canvas = document.getElementById('register-mascot-canvas');
        const container = document.querySelector('.mascot-container');
        
        if (!canvas || !container) return;

        const scene = new THREE.Scene();
        scene.background = null; 

        // KAMERA: Disamakan dengan Login (Z=5.8) agar Zoom-nya pas
        const camera = new THREE.PerspectiveCamera(40, container.clientWidth / container.clientHeight, 0.1, 1000);
        camera.position.z = 5.8; 
        camera.position.y = 0; 

        const renderer = new THREE.WebGLRenderer({ 
            canvas: canvas, 
            alpha: true, 
            antialias: true,
            premultipliedAlpha: false 
        });
        
        renderer.setSize(container.clientWidth, container.clientHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.shadowMap.enabled = true;
        renderer.outputColorSpace = THREE.SRGBColorSpace;
        renderer.setClearColor(0x000000, 0); 

        // --- MODELING (Sama Persis dengan Login) ---
        const mascotGroup = new THREE.Group();
        scene.add(mascotGroup);

        const furColor = new THREE.Color(0xFF8800);
        const creamColor = new THREE.Color(0xFFFDD0);
        const noseColor = new THREE.Color(0x222222);

        const mainFurMat = new THREE.MeshStandardMaterial({ color: furColor, roughness: 0.5 });
        const creamFurMat = new THREE.MeshStandardMaterial({ color: creamColor, roughness: 0.6 });
        const noseMat = new THREE.MeshStandardMaterial({ color: noseColor, roughness: 0.3 });

        // HEAD
        const head = new THREE.Mesh(new THREE.SphereGeometry(1.0, 32, 32), mainFurMat);
        head.scale.set(1.1, 0.95, 1.0); mascotGroup.add(head);

        // SNOUT
        const snout = new THREE.Mesh(new THREE.SphereGeometry(0.45, 32, 32), creamFurMat);
        snout.position.set(0, -0.3, 0.85); snout.scale.set(1, 0.8, 1.2); head.add(snout);

        // CHEEKS
        const cheekGeo = new THREE.SphereGeometry(0.45, 32, 32);
        const cheekL = new THREE.Mesh(cheekGeo, creamFurMat);
        cheekL.position.set(-0.6, -0.35, 0.5); cheekL.scale.set(1, 0.8, 0.8); head.add(cheekL);
        const cheekR = new THREE.Mesh(cheekGeo, creamFurMat);
        cheekR.position.set(0.6, -0.35, 0.5); cheekR.scale.set(1, 0.8, 0.8); head.add(cheekR);

        // NOSE
        const nose = new THREE.Mesh(new THREE.SphereGeometry(0.12, 16, 16), noseMat);
        nose.position.set(0, 0.1, 0.45); nose.scale.set(1.5, 1, 1); snout.add(nose);

        // EARS
        const earGeo = new THREE.ConeGeometry(0.35, 0.9, 32);
        const earInnerGeo = new THREE.ConeGeometry(0.2, 0.6, 32);
        const earL = new THREE.Mesh(earGeo, mainFurMat);
        earL.position.set(-0.6, 0.85, 0); earL.rotation.z = 0.3; earL.rotation.x = -0.1; head.add(earL);
        const earLInner = new THREE.Mesh(earInnerGeo, creamFurMat);
        earLInner.position.set(0, -0.1, 0.18); earL.add(earLInner);
        const earR = new THREE.Mesh(earGeo, mainFurMat);
        earR.position.set(0.6, 0.85, 0); earR.rotation.z = -0.3; earR.rotation.x = -0.1; head.add(earR);
        const earRInner = new THREE.Mesh(earInnerGeo, creamFurMat);
        earRInner.position.set(0, -0.1, 0.18); earR.add(earRInner);

        // EYES
        const eyeWhiteGeo = new THREE.SphereGeometry(0.28, 32, 32);
        const eyeWhiteMat = new THREE.MeshStandardMaterial({ color: 0xFFFFFF, roughness: 0.1 });
        const pupilGeo = new THREE.SphereGeometry(0.12, 16, 16);
        const pupilMat = new THREE.MeshBasicMaterial({ color: 0x111111 });
        
        const eyeL = new THREE.Mesh(eyeWhiteGeo, eyeWhiteMat);
        eyeL.position.set(-0.35, 0.05, 0.82); eyeL.scale.set(1, 1.1, 0.5); head.add(eyeL);
        const pupilL = new THREE.Mesh(pupilGeo, pupilMat);
        pupilL.position.z = 0.25; eyeL.add(pupilL);
        
        const eyeR = new THREE.Mesh(eyeWhiteGeo, eyeWhiteMat);
        eyeR.position.set(0.35, 0.05, 0.82); eyeR.scale.set(1, 1.1, 0.5); head.add(eyeR);
        const pupilR = new THREE.Mesh(pupilGeo, pupilMat);
        pupilR.position.z = 0.25; eyeR.add(pupilR);

        // BROWS
        const browGeo = new THREE.CapsuleGeometry(0.05, 0.3, 4, 8);
        const browMat = new THREE.MeshStandardMaterial({ color: furColor });
        const browL = new THREE.Mesh(browGeo, browMat);
        browL.rotation.z = Math.PI / 2 + 0.2; browL.position.set(-0.35, 0.4, 0.85); head.add(browL);
        const browR = new THREE.Mesh(browGeo, browMat);
        browR.rotation.z = Math.PI / 2 - 0.2; browR.position.set(0.35, 0.4, 0.85); head.add(browR);

        // LIGHTING
        const ambientLight = new THREE.HemisphereLight(0xffffff, 0xffeedd, 0.5); scene.add(ambientLight);
        const mainLight = new THREE.DirectionalLight(0xffffff, 1.2); mainLight.position.set(5, 10, 7); scene.add(mainLight);
        const rimLight = new THREE.DirectionalLight(0x4f46e5, 1.5); // Rim light
        rimLight.position.set(-5, 5, -5); scene.add(rimLight);

        // MOUSE INTERACTION
        let mouseX = 0; let mouseY = 0;
        document.addEventListener('mousemove', (event) => {
            const windowHalfX = window.innerWidth / 2;
            const windowHalfY = window.innerHeight / 2;
            mouseX = (event.clientX - windowHalfX) / windowHalfX;
            mouseY = (event.clientY - windowHalfY) / windowHalfY;
        });

        // RESIZE
        window.addEventListener('resize', () => {
            const width = container.clientWidth;
            const height = container.clientHeight;
            renderer.setSize(width, height);
            camera.aspect = width / height;
            camera.updateProjectionMatrix();
        });

        // ANIMATE
        function animate() {
            requestAnimationFrame(animate);
            const time = Date.now() * 0.001;

            const pupilLimit = 0.15;
            const targetPupilX = Math.max(-pupilLimit, Math.min(pupilLimit, mouseX * 0.3));
            const targetPupilY = Math.max(-pupilLimit, Math.min(pupilLimit, -mouseY * 0.3));
            
            pupilL.position.x = THREE.MathUtils.lerp(pupilL.position.x, targetPupilX, 0.15);
            pupilL.position.y = THREE.MathUtils.lerp(pupilL.position.y, targetPupilY, 0.15);
            pupilR.position.x = THREE.MathUtils.lerp(pupilR.position.x, targetPupilX, 0.15);
            pupilR.position.y = THREE.MathUtils.lerp(pupilR.position.y, targetPupilY, 0.15);

            const targetHeadRotX = -mouseY * 0.25;
            const targetHeadRotY = mouseX * 0.35;
            mascotGroup.rotation.x = THREE.MathUtils.lerp(mascotGroup.rotation.x, targetHeadRotX, 0.08);
            mascotGroup.rotation.y = THREE.MathUtils.lerp(mascotGroup.rotation.y, targetHeadRotY, 0.08);

            mascotGroup.position.y = Math.sin(time * 1.5) * 0.1;
            earL.rotation.z = 0.3 + Math.sin(time * 3) * 0.05;
            earR.rotation.z = -0.3 - Math.cos(time * 2.5) * 0.05;

            renderer.render(scene, camera);
        }
        animate();
    }

    if (document.readyState === 'complete') initMascot();
    else window.addEventListener('load', initMascot);
</script>
{% endblock %}