{% extends "base.html" %}

{% block content %}

<div style="display: flex; align-items: center; justify-content: center; min-height: 80vh; padding: 20px;">
    
    <!-- Card Besar Split Layout -->
    <div class="auth-card" style="display: flex; flex-wrap: wrap; background: white; border-radius: 24px; box-shadow: 0 10px 40px rgba(0,0,0,0.08); overflow: hidden; max-width: 1000px; width: 100%; border: 1px solid #eee;">
        
        <!-- BAGIAN KIRI: FORMULIR -->
        <div style="flex: 1; min-width: 350px; padding: 40px;">
            <div class="section-header" style="text-align: left; margin-bottom: 15px;">
                <h2 style="font-size: 1.8rem; margin-bottom: 5px;">Buat Akun Baru</h2>
                <p style="color: #666; font-size: 0.9rem;">Hubungkan wallet Ganache Anda untuk kemudahan akses.</p>
            </div>

            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div style="padding: 8px 12px; margin-bottom: 15px; border-radius: 8px; font-size: 0.8rem;
                                    background: {{ '#e8f5e9' if category == 'success' else '#ffebee' }};
                                    color: {{ '#2e7d32' if category == 'success' else '#c62828' }};">
                            {{ message }}
                        </div>
                    {% endfor %}
                {% endif %}
            {% endwith %}

            <form method="POST">
                <!-- Jarak diperkecil lagi menjadi 6px -->
                <div style="margin-bottom: 6px;">
                    <label style="font-weight: 600; font-size: 0.85rem; color: #333;">Username</label>
                    <input type="text" name="username" class="input-field" required style="margin-top: 2px; font-size: 0.9rem; padding: 10px;">
                </div>

                <div style="margin-bottom: 6px;">
                    <label style="font-weight: 600; font-size: 0.85rem; color: #333;">Email</label>
                    <input type="email" name="email" class="input-field" required style="margin-top: 2px; font-size: 0.9rem; padding: 10px;">
                </div>

                <div style="margin-bottom: 6px;">
                    <label style="font-weight: 600; font-size: 0.85rem; color: #333;">Password</label>
                    <input type="password" name="password" class="input-field" required style="margin-top: 2px; font-size: 0.9rem; padding: 10px;">
                </div>

                <div style="margin-bottom: 10px;">
                    <label style="font-weight: 600; font-size: 0.85rem; color: #333;">Role</label>
                    <!-- Style disesuaikan agar normal -->
                    <select name="role" class="input-field" style="width: 100%; padding: 10px; margin-top: 2px; font-size: 0.9rem; background-color: white; border-radius: 8px;">
                        <option value="donor">Donatur (Ingin Berdonasi)</option>
                        <option value="creator">Kreator (Ingin Galang Dana)</option>
                    </select>
                </div>

                <!-- Section Koneksi Blockchain -->
                <div style="background: #fff3e0; padding: 12px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #ffe0b2;">
                    <p style="font-size: 0.8rem; color: #e65100; margin-bottom: 8px; line-height: 1.3;">
                        <i class="fa-solid fa-link"></i> <strong>Koneksi Blockchain:</strong><br>
                        Pilih akun Ganache dan masukkan Key.
                    </p>

                    <div style="margin-bottom: 8px;">
                        <label style="font-weight: 600; font-size: 0.8rem; color: #e65100;">Pilih Alamat Wallet</label>
                        <!-- Perbaikan style dropdown wallet: Hapus height fixed & font monospace agar terlihat normal -->
                        <select name="wallet_address" class="input-field" style="width: 100%; padding: 8px; margin-top: 2px; font-size: 0.85rem; background-color: white;">
                            {% for acc in accounts %}
                                <option value="{{ acc }}">{{ acc }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div>
                        <label style="font-weight: 600; font-size: 0.8rem; color: #e65100;">Private Key (Verifikasi)</label>
                        <input type="password" name="private_key" class="input-field" placeholder="Tempel Private Key..." required style="margin-top: 2px; font-size: 0.8rem; padding: 8px;">
                    </div>
                </div>

                <button type="submit" class="button button-full" style="height: 45px; font-size: 0.95rem;">Daftar & Hubungkan</button>
            </form>
            
            <p style="text-align: center; margin-top: 15px; font-size: 0.85rem; color: #666;">
                Sudah punya akun? <a href="/login" style="color: var(--primary); font-weight: 600; text-decoration: none;">Login</a>
            </p>
        </div>

        <!-- BAGIAN KANAN: MASKOT 3D -->
        <div class="mascot-container" style="flex: 1; min-width: 350px; background: linear-gradient(135deg, #FFF 0%, #FFF3E0 100%); position: relative; min-height: 400px;">
             <!-- Canvas untuk Three.js -->
             <canvas id="register-mascot-canvas" style="width: 100%; height: 100%; display: block; outline: none;"></canvas>
             
             <!-- Teks Dekorasi -->
             <div style="position: absolute; bottom: 30px; left: 0; right: 0; text-align: center; pointer-events: none;">
                 <h3 style="color: #D32F2F; opacity: 0.8; font-size: 1.1rem;">"Siap Berbagi Kebaikan?"</h3>
             </div>
        </div>
    </div>
</div>

<!-- SCRIPTS 3D -->
<script async src="https://unpkg.com/es-module-shims@1.6.3/dist/es-module-shims.js"></script>
<script type="importmap">
  { "imports": { "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js" } }
</script>

<script type="module">
    import * as THREE from 'three';

    function initMascot() {
        const canvas = document.getElementById('register-mascot-canvas');
        const container = document.querySelector('.mascot-container');
        
        if (!canvas || !container) return;

        const scene = new THREE.Scene();
        scene.background = null; 
        
        const camera = new THREE.PerspectiveCamera(45, container.clientWidth / container.clientHeight, 0.1, 1000);
        
        // Posisi kamera tetap 7 agar ukuran maskot pas
        camera.position.z = 7; 
        camera.position.y = 0;

        const renderer = new THREE.WebGLRenderer({ canvas: canvas, alpha: true, antialias: true });
        renderer.setSize(container.clientWidth, container.clientHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.shadowMap.enabled = true;
        renderer.outputColorSpace = THREE.SRGBColorSpace;

        // --- MODELING RUBAH (Sama) ---
        const mascotGroup = new THREE.Group();
        scene.add(mascotGroup);

        const furColor = new THREE.Color(0xFF8800);
        const creamColor = new THREE.Color(0xFFFDD0);
        const noseColor = new THREE.Color(0x222222);

        const mainFurMat = new THREE.MeshStandardMaterial({ color: furColor, roughness: 0.5 });
        const creamFurMat = new THREE.MeshStandardMaterial({ color: creamColor, roughness: 0.6 });
        const noseMat = new THREE.MeshStandardMaterial({ color: noseColor, roughness: 0.3 });

        const head = new THREE.Mesh(new THREE.SphereGeometry(1.0, 32, 32), mainFurMat);
        head.scale.set(1.1, 0.95, 1.0);
        mascotGroup.add(head);

        const snout = new THREE.Mesh(new THREE.SphereGeometry(0.45, 32, 32), creamFurMat);
        snout.position.set(0, -0.3, 0.85); snout.scale.set(1, 0.8, 1.2); head.add(snout);

        const cheekGeo = new THREE.SphereGeometry(0.45, 32, 32);
        const cheekL = new THREE.Mesh(cheekGeo, creamFurMat);
        cheekL.position.set(-0.6, -0.35, 0.5); cheekL.scale.set(1, 0.8, 0.8); head.add(cheekL);
        const cheekR = new THREE.Mesh(cheekGeo, creamFurMat);
        cheekR.position.set(0.6, -0.35, 0.5); cheekR.scale.set(1, 0.8, 0.8); head.add(cheekR);

        const nose = new THREE.Mesh(new THREE.SphereGeometry(0.12, 16, 16), noseMat);
        nose.position.set(0, 0.1, 0.45); nose.scale.set(1.5, 1, 1); snout.add(nose);

        const earGeo = new THREE.ConeGeometry(0.35, 0.9, 32);
        const earInnerGeo = new THREE.ConeGeometry(0.2, 0.6, 32);
        const earL = new THREE.Mesh(earGeo, mainFurMat);
        earL.position.set(-0.6, 0.85, 0); earL.rotation.z = 0.3; earL.rotation.x = -0.1; head.add(earL);
        const earLInner = new THREE.Mesh(earInnerGeo, creamFurMat);
        earLInner.position.set(0, -0.1, 0.18); earL.add(earLInner);
        const earR = new THREE.Mesh(earGeo, mainFurMat);
        earR.position.set(0.6, 0.85, 0); earR.rotation.z = -0.3; earR.rotation.x = -0.1; head.add(earR);
        const earRInner = new THREE.Mesh(earInnerGeo, creamFurMat);
        earRInner.position.set(0, -0.1, 0.18); earR.add(earRInner);

        const eyeWhiteGeo = new THREE.SphereGeometry(0.28, 32, 32);
        const eyeWhiteMat = new THREE.MeshStandardMaterial({ color: 0xFFFFFF, roughness: 0.1 });
        const pupilGeo = new THREE.SphereGeometry(0.12, 16, 16);
        const pupilMat = new THREE.MeshBasicMaterial({ color: 0x111111 });
        const eyeL = new THREE.Mesh(eyeWhiteGeo, eyeWhiteMat);
        eyeL.position.set(-0.35, 0.05, 0.82); eyeL.scale.set(1, 1.1, 0.5); head.add(eyeL);
        const pupilL = new THREE.Mesh(pupilGeo, pupilMat);
        pupilL.position.z = 0.25; eyeL.add(pupilL);
        const eyeR = new THREE.Mesh(eyeWhiteGeo, eyeWhiteMat);
        eyeR.position.set(0.35, 0.05, 0.82); eyeR.scale.set(1, 1.1, 0.5); head.add(eyeR);
        const pupilR = new THREE.Mesh(pupilGeo, pupilMat);
        pupilR.position.z = 0.25; eyeR.add(pupilR);

        const browGeo = new THREE.CapsuleGeometry(0.05, 0.3, 4, 8);
        const browMat = new THREE.MeshStandardMaterial({ color: furColor });
        const browL = new THREE.Mesh(browGeo, browMat);
        browL.rotation.z = Math.PI / 2 + 0.2; browL.position.set(-0.35, 0.4, 0.85); head.add(browL);
        const browR = new THREE.Mesh(browGeo, browMat);
        browR.rotation.z = Math.PI / 2 - 0.2; browR.position.set(0.35, 0.4, 0.85); head.add(browR);

        const ambientLight = new THREE.HemisphereLight(0xffffff, 0xffeedd, 0.6); scene.add(ambientLight);
        const mainLight = new THREE.DirectionalLight(0xffffff, 1.5); mainLight.position.set(5, 10, 7); scene.add(mainLight);
        const rimLight = new THREE.DirectionalLight(0xffaa00, 0.5); rimLight.position.set(-5, 5, -5); scene.add(rimLight);

        let mouseX = 0; let mouseY = 0;
        document.addEventListener('mousemove', (event) => {
            const windowHalfX = window.innerWidth / 2;
            const windowHalfY = window.innerHeight / 2;
            mouseX = (event.clientX - windowHalfX) / windowHalfX;
            mouseY = (event.clientY - windowHalfY) / windowHalfY;
        });

        window.addEventListener('resize', () => {
            const width = container.clientWidth;
            const height = container.clientHeight;
            renderer.setSize(width, height);
            camera.aspect = width / height;
            camera.updateProjectionMatrix();
        });

        function animate() {
            requestAnimationFrame(animate);
            const time = Date.now() * 0.001;

            const pupilLimit = 0.15;
            const targetPupilX = Math.max(-pupilLimit, Math.min(pupilLimit, mouseX * 0.3));
            const targetPupilY = Math.max(-pupilLimit, Math.min(pupilLimit, -mouseY * 0.3));
            pupilL.position.x = THREE.MathUtils.lerp(pupilL.position.x, targetPupilX, 0.15);
            pupilL.position.y = THREE.MathUtils.lerp(pupilL.position.y, targetPupilY, 0.15);
            pupilR.position.x = THREE.MathUtils.lerp(pupilR.position.x, targetPupilX, 0.15);
            pupilR.position.y = THREE.MathUtils.lerp(pupilR.position.y, targetPupilY, 0.15);

            const targetHeadRotX = -mouseY * 0.25;
            const targetHeadRotY = mouseX * 0.35;
            mascotGroup.rotation.x = THREE.MathUtils.lerp(mascotGroup.rotation.x, targetHeadRotX, 0.08);
            mascotGroup.rotation.y = THREE.MathUtils.lerp(mascotGroup.rotation.y, targetHeadRotY, 0.08);

            mascotGroup.position.y = Math.sin(time * 1.5) * 0.1;
            earL.rotation.z = 0.3 + Math.sin(time * 3) * 0.05;
            earR.rotation.z = -0.3 - Math.cos(time * 2.5) * 0.05;

            renderer.render(scene, camera);
        }
        animate();
    }

    if (document.readyState === 'complete') initMascot();
    else window.addEventListener('load', initMascot);
</script>

{% endblock %}